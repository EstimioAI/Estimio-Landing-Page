---
const steps = [
  {
    number: 1,
    title: "Describe the Job",
    description:
      "Tell Estimio about the project using text or photos. Include dimensions, materials, and scope.",
    image: "/assets/screenshots/Hero Image Middle.png",
  },
  {
    number: 2,
    title: "AI Generates Estimate",
    description:
      "Our AI analyzes your input and creates a detailed, accurate estimate with localized pricing.",
    image: "/assets/screenshots/Breakdown.png",
  },
  {
    number: 3,
    title: "Adjust your Margins",
    description:
      "Fine-tune labor and material markups to ensure maximum profitability on every job.",
    image: "/assets/screenshots/Pricing.png",
  },
  {
    number: 4,
    title: "Send to Client",
    description:
      "Review, customize if needed, and send professional proposals directly to your clients.",
    image: "/assets/screenshots/Proposal.png",
  },
];
---

<section
  id="how-it-works"
  class="pt-0 pb-12 md:pb-20 lg:pb-24 bg-white scroll-mt-20"
  aria-labelledby="how-it-works-heading"
>
  <div class="section-container">
    <!-- Desktop Layout -->
    <div class="hidden lg:block max-w-6xl mx-auto px-4">
      <h2 id="how-it-works-heading" class="sr-only">How It Works</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-center">
        <!-- Left: Step Cards -->
        <div class="relative flex flex-col order-2 lg:order-1 min-w-0">
          <div
            id="hiw-steps-container-desktop"
            class="flex flex-col gap-4"
          >
            {
              steps.map((step, index) => (
                <button
                  type="button"
                  data-step={step.number}
                  data-image={step.image}
                  class:list={[
                    "hiw-step-card-desktop",
                    "text-left p-5 md:p-6 rounded-2xl border-2 transition-all duration-300 cursor-pointer relative z-10",
                    "w-full",
                    "hover:border-primary",
                    index === 0
                      ? "bg-primary/5 border-primary shadow-lg shadow-primary/10"
                      : "border-gray-200 bg-white hover:bg-primary/5",
                    "focus:outline-none",
                  ]}
                >
                  <div class="flex items-start gap-4">
                    <span
                      class:list={[
                        "text-3xl md:text-4xl font-bold shrink-0",
                        "bg-clip-text text-transparent bg-gradient-to-br from-primary to-primary/60",
                      ]}
                    >
                      0{step.number}
                    </span>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg md:text-xl font-semibold mb-1 text-text-primary">
                        {step.title}
                      </h3>
                      <p class="text-sm md:text-base leading-relaxed text-text-secondary">
                        {step.description}
                      </p>
                    </div>
                  </div>
                </button>
              ))
            }
          </div>
        </div>

        <!-- Right: Phone Image -->
        <div class="flex justify-center order-1 lg:order-2">
          <div class="relative w-[320px] xl:w-[360px]">
            <!-- Phone images container -->
            <div id="hiw-phone-container-desktop" class="relative">
              {
                steps.map((step, index) => (
                  <img
                    src={step.image}
                    alt={`Estimio app - ${step.title}`}
                    data-step={step.number}
                    class:list={[
                      "hiw-phone-image-desktop",
                      "w-full md:drop-shadow-2xl rounded-[2rem]",
                      index === 0
                        ? "relative opacity-100"
                        : "absolute inset-0 opacity-0",
                    ]}
                    style="transition: opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1);"
                    width="360"
                    height="740"
                    loading={index === 0 ? "eager" : "lazy"}
                    decoding="async"
                  />
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Carousel Layout -->
    <div class="lg:hidden max-w-6xl mx-auto">
      <!-- Phone Image Carousel -->
      <div class="relative w-full mb-8 overflow-hidden">
        <div class="flex justify-center items-center">
          <!-- Left Arrow -->
          <button
            type="button"
            id="hiw-arrow-left"
            class="hiw-arrow hidden absolute left-2 sm:left-4 z-10 w-10 h-10 rounded-full bg-white/90 shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-white hover:text-primary transition-all duration-200 active:scale-95"
            aria-label="Previous step"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <div class="relative w-[280px] sm:w-[320px]">
            <!-- Phone carousel -->
            <div
              id="hiw-phone-carousel"
              class="relative overflow-hidden touch-pan-y"
              style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;"
            >
              <div
                id="hiw-phone-track"
                class="flex transition-transform duration-300 ease-out"
                style="transform: translateX(0%);"
              >
                {
                  steps.map((step, index) => (
                    <div class="flex-shrink-0 w-full">
                      <img
                        src={step.image}
                        alt={`Estimio app - ${step.title}`}
                        class="w-full md:drop-shadow-2xl rounded-[2rem]"
                        width="360"
                        height="740"
                        loading={index === 0 ? "eager" : "lazy"}
                        decoding="async"
                      />
                    </div>
                  ))
                }
              </div>
            </div>
          </div>

          <!-- Right Arrow -->
          <button
            type="button"
            id="hiw-arrow-right"
            class="hiw-arrow absolute right-2 sm:right-4 z-10 w-10 h-10 rounded-full bg-white/90 shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-white hover:text-primary transition-all duration-200 active:scale-95"
            aria-label="Next step"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Description Carousel -->
      <div class="px-4">
        <div
          id="hiw-desc-carousel"
          class="relative overflow-hidden"
          style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;"
        >
          <div
            id="hiw-desc-track"
            class="flex transition-transform duration-300 ease-out"
            style="transform: translateX(0%);"
          >
            {
              steps.map((step) => (
                <div class="flex-shrink-0 w-full px-2">
                  <div class="text-center">
                    <span class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-br from-primary to-primary/60">
                      0{step.number}
                    </span>
                    <h3 class="text-xl font-semibold mb-2 text-text-primary mt-2">
                      {step.title}
                    </h3>
                    <p class="text-base leading-relaxed text-text-secondary">
                      {step.description}
                    </p>
                  </div>
                </div>
              ))
            }
          </div>
        </div>

        <!-- Progress Indicators -->
        <div class="flex justify-center gap-2 mt-6">
          {
            steps.map((step, index) => (
              <button
                type="button"
                data-dot-index={index}
                class:list={[
                  "hiw-dot",
                  "h-1.5 rounded-full transition-all duration-300",
                  index === 0
                    ? "w-8 bg-primary"
                    : "w-1.5 bg-gray-300",
                ]}
                aria-label={`Go to step ${step.number}`}
              />
            ))
          }
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Desktop functionality
  function initHowItWorksDesktop() {
    const stepCards = document.querySelectorAll<HTMLButtonElement>(".hiw-step-card-desktop");
    const phoneImages = document.querySelectorAll<HTMLImageElement>(".hiw-phone-image-desktop");

    if (stepCards.length === 0) return;

    function setActiveStep(stepNumber: number) {
      stepCards.forEach((card) => {
        const cardStep = parseInt(card.dataset.step || "1", 10);
        const isActive = cardStep === stepNumber;

        if (isActive) {
          card.classList.remove("border-gray-200", "bg-white", "hover:bg-primary/5");
          card.classList.add("border-primary", "bg-primary/5", "shadow-lg", "shadow-primary/10");
        } else {
          card.classList.remove("border-primary", "bg-primary/5", "shadow-lg", "shadow-primary/10");
          card.classList.add("border-gray-200", "bg-white", "hover:bg-primary/5");
        }
      });

      phoneImages.forEach((img) => {
        const imgStep = parseInt(img.dataset.step || "1", 10);
        if (imgStep === stepNumber) {
          img.classList.remove("opacity-0", "absolute", "inset-0");
          img.classList.add("opacity-100", "relative");
        } else {
          img.classList.remove("opacity-100", "relative");
          img.classList.add("opacity-0", "absolute", "inset-0");
        }
      });
    }

    stepCards.forEach((card) => {
      card.addEventListener("click", () => {
        const stepNumber = parseInt(card.dataset.step || "1", 10);
        setActiveStep(stepNumber);
      });
    });
  }

  // Mobile carousel functionality
  function initHowItWorksMobile() {
    const phoneCarousel = document.getElementById("hiw-phone-carousel");
    const descCarousel = document.getElementById("hiw-desc-carousel");
    const phoneTrack = document.getElementById("hiw-phone-track") as HTMLElement | null;
    const descTrack = document.getElementById("hiw-desc-track") as HTMLElement | null;
    const dots = document.querySelectorAll<HTMLButtonElement>(".hiw-dot");
    const arrowLeft = document.getElementById("hiw-arrow-left") as HTMLButtonElement | null;
    const arrowRight = document.getElementById("hiw-arrow-right") as HTMLButtonElement | null;

    if (!phoneCarousel || !descCarousel || !phoneTrack || !descTrack) return;

    let currentIndex = 0;
    const totalSteps = 4;
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;
    let isDragging = false;
    let isHorizontalSwipe = false;
    let startTranslate = 0;

    function updateArrows() {
      if (arrowLeft) {
        if (currentIndex === 0) {
          arrowLeft.classList.add("hidden");
        } else {
          arrowLeft.classList.remove("hidden");
          arrowLeft.classList.add("flex");
        }
      }
      if (arrowRight) {
        if (currentIndex === totalSteps - 1) {
          arrowRight.classList.add("hidden");
        } else {
          arrowRight.classList.remove("hidden");
          arrowRight.classList.add("flex");
        }
      }
    }

    function updateCarousel(index: number, animate = true) {
      currentIndex = Math.max(0, Math.min(index, totalSteps - 1));
      const translateX = -currentIndex * 100;

      if (!animate) {
        phoneTrack.style.transition = "none";
        descTrack.style.transition = "none";
      } else {
        phoneTrack.style.transition = "transform 0.3s ease-out";
        descTrack.style.transition = "transform 0.3s ease-out";
      }

      phoneTrack.style.transform = `translateX(${translateX}%)`;
      descTrack.style.transform = `translateX(${translateX}%)`;

      // Update dots
      dots.forEach((dot, i) => {
        if (i === currentIndex) {
          dot.classList.remove("w-1.5", "bg-gray-300");
          dot.classList.add("w-8", "bg-primary");
        } else {
          dot.classList.remove("w-8", "bg-primary");
          dot.classList.add("w-1.5", "bg-gray-300");
        }
      });

      // Update arrow visibility
      updateArrows();

      // Re-enable transitions after update
      if (!animate) {
        setTimeout(() => {
          phoneTrack.style.transition = "transform 0.3s ease-out";
          descTrack.style.transition = "transform 0.3s ease-out";
        }, 10);
      }
    }

    function handleDragStart(e: TouchEvent | MouseEvent) {
      isDragging = true;
      isHorizontalSwipe = false;
      startX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      startY = 'touches' in e ? e.touches[0].clientY : e.clientY;
      startTranslate = -currentIndex * 100;
      phoneTrack.style.transition = "none";
      descTrack.style.transition = "none";
    }

    function handleDragMove(e: TouchEvent | MouseEvent) {
      if (!isDragging) return;

      currentX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      currentY = 'touches' in e ? e.touches[0].clientY : e.clientY;

      const diffX = currentX - startX;
      const diffY = currentY - startY;

      // Determine swipe direction on first significant movement
      if (!isHorizontalSwipe && (Math.abs(diffX) > 10 || Math.abs(diffY) > 10)) {
        isHorizontalSwipe = Math.abs(diffX) > Math.abs(diffY);
      }

      // Only handle horizontal swipes, allow vertical scrolling
      if (!isHorizontalSwipe) {
        return;
      }

      // Prevent default only for horizontal swipes
      e.preventDefault();

      const containerWidth = phoneCarousel.offsetWidth;
      const percentageMoved = (diffX / containerWidth) * 100;
      const newTranslate = startTranslate + percentageMoved;

      // Add resistance at edges
      const maxTranslate = 0;
      const minTranslate = -(totalSteps - 1) * 100;
      const constrainedTranslate = Math.max(minTranslate, Math.min(maxTranslate, newTranslate));

      phoneTrack.style.transform = `translateX(${constrainedTranslate}%)`;
      descTrack.style.transform = `translateX(${constrainedTranslate}%)`;
    }

    function handleDragEnd() {
      if (!isDragging) return;
      isDragging = false;

      // Only process if it was a horizontal swipe
      if (!isHorizontalSwipe) {
        return;
      }

      const diff = currentX - startX;
      const threshold = 50; // Minimum drag distance to trigger slide

      if (Math.abs(diff) > threshold) {
        if (diff > 0) {
          // Dragged right - go to previous
          updateCarousel(currentIndex - 1);
        } else {
          // Dragged left - go to next
          updateCarousel(currentIndex + 1);
        }
      } else {
        // Snap back to current
        updateCarousel(currentIndex);
      }
    }

    // Touch events for phone carousel
    phoneCarousel.addEventListener("touchstart", handleDragStart, { passive: true });
    phoneCarousel.addEventListener("touchmove", handleDragMove, { passive: false });
    phoneCarousel.addEventListener("touchend", handleDragEnd, { passive: true });

    // Touch events for description carousel
    descCarousel.addEventListener("touchstart", handleDragStart, { passive: true });
    descCarousel.addEventListener("touchmove", handleDragMove, { passive: false });
    descCarousel.addEventListener("touchend", handleDragEnd, { passive: true });

    // Mouse events (for desktop testing)
    phoneCarousel.addEventListener("mousedown", handleDragStart);
    descCarousel.addEventListener("mousedown", handleDragStart);
    document.addEventListener("mousemove", handleDragMove);
    document.addEventListener("mouseup", handleDragEnd);

    // Dot click handlers
    dots.forEach((dot, index) => {
      dot.addEventListener("click", () => {
        updateCarousel(index);
      });
    });

    // Arrow click handlers
    if (arrowLeft) {
      arrowLeft.addEventListener("click", () => {
        if (currentIndex > 0) {
          updateCarousel(currentIndex - 1);
        }
      });
    }
    if (arrowRight) {
      arrowRight.addEventListener("click", () => {
        if (currentIndex < totalSteps - 1) {
          updateCarousel(currentIndex + 1);
        }
      });
    }

    // Initialize
    updateCarousel(0, false);
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initHowItWorksDesktop();
      initHowItWorksMobile();
    });
  } else {
    initHowItWorksDesktop();
    initHowItWorksMobile();
  }
</script>

<style>
  /* Prevent text selection during drag */
  #hiw-phone-carousel,
  #hiw-desc-carousel {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  /* Hardware acceleration */
  #hiw-phone-track,
  #hiw-desc-track {
    will-change: transform;
  }

  /* Smooth touch scrolling */
  #hiw-phone-carousel,
  #hiw-desc-carousel {
    -webkit-overflow-scrolling: touch;
    cursor: grab;
  }

  #hiw-phone-carousel:active,
  #hiw-desc-carousel:active {
    cursor: grabbing;
  }
</style>
