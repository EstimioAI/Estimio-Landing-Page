---
const steps = [
  {
    number: 1,
    title: "Describe the Job",
    description:
      "Tell Estimio about the project using text or photos. Include dimensions, materials, and scope.",
    image: "/assets/screenshots/Hero Image Middle.png",
  },
  {
    number: 2,
    title: "AI Generates Estimate",
    description:
      "Our AI analyzes your input and creates a detailed, accurate estimate with localized pricing.",
    image: "/assets/screenshots/Breakdown.png",
  },
  {
    number: 3,
    title: "Adjust your Margins",
    description:
      "Fine-tune labor and material markups to ensure maximum profitability on every job.",
    image: "/assets/screenshots/Pricing.png",
  },
  {
    number: 4,
    title: "Send to Client",
    description:
      "Review, customize if needed, and send professional proposals directly to your clients.",
    image: "/assets/screenshots/Proposal.png",
  },
];
---

<section
  id="how-it-works"
  class="pt-0 pb-12 md:pb-20 lg:pb-24 bg-white scroll-mt-20"
>
  <div class="section-container">
    <!-- Section Header Removed for seamless transition -->

    <!-- Interactive Layout -->
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-center">
        <!-- Left: Step Cards -->
        <div class="relative flex flex-col order-2 lg:order-1 min-w-0">
          <!-- Steps Container -->
          <div
            id="hiw-steps-container"
            class="flex flex-row lg:flex-col gap-4 overflow-x-auto lg:overflow-visible snap-x snap-mandatory py-4 -mx-4 px-4 lg:p-0 lg:m-0 no-scrollbar"
          >
            {
              steps.map((step, index) => (
                <button
                  type="button"
                  data-step={step.number}
                  data-image={step.image}
                  class:list={[
                    "hiw-step-card",
                    "gsap-fade-up",
                    "text-left p-5 md:p-6 rounded-2xl border-2 transition-all duration-300 cursor-pointer relative z-10",
                    "min-w-[85vw] sm:min-w-[380px] lg:min-w-0 lg:w-full snap-center",
                    "hover:border-primary",
                    index === 0
                      ? "bg-primary/5 border-primary shadow-lg shadow-primary/10"
                      : "border-gray-200 bg-white hover:bg-primary/5",
                    "focus:outline-none",
                  ]}
                >
                  <div class="flex items-start gap-4">
                    <span
                      class:list={[
                        "hiw-step-number",
                        "text-3xl md:text-4xl font-bold shrink-0",
                        "bg-clip-text text-transparent bg-gradient-to-br from-primary to-primary/60",
                      ]}
                    >
                      0{step.number}
                    </span>
                    <div class="flex-1 min-w-0">
                      <h3
                        class:list={[
                          "hiw-step-title",
                          "text-lg md:text-xl font-semibold mb-1 text-text-primary",
                        ]}
                      >
                        {step.title}
                      </h3>
                      <p
                        class:list={[
                          "hiw-step-desc",
                          "text-sm md:text-base leading-relaxed text-text-secondary",
                        ]}
                      >
                        {step.description}
                      </p>
                    </div>
                  </div>
                </button>
              ))
            }
          </div>
        </div>

        <!-- Right: Phone Image -->
        <div class="flex justify-center order-1 lg:order-2">
          <div
            class="relative w-[280px] sm:w-[320px] md:w-[340px] lg:w-[320px] xl:w-[360px]"
          >
            <!-- Glow effect -->
            <div
              class="absolute inset-0 bg-blue-500/20 blur-[60px] scale-95 translate-y-4 rounded-[3rem]"
            >
            </div>
            <!-- Phone images container -->
            <div id="hiw-phone-container" class="relative">
              {
                steps.map((step, index) => (
                  <img
                    src={step.image}
                    alt={step.title}
                    data-step={step.number}
                    class:list={[
                      "hiw-phone-image",
                      "w-full drop-shadow-2xl rounded-[2rem]",
                      index === 0
                        ? "relative opacity-100"
                        : "absolute inset-0 opacity-0",
                    ]}
                    style="transition: opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1), transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);"
                    width="360"
                    height="740"
                  />
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function initHowItWorks() {
    const stepCards =
      document.querySelectorAll<HTMLButtonElement>(".hiw-step-card");
    const phoneImages =
      document.querySelectorAll<HTMLImageElement>(".hiw-phone-image");

    if (stepCards.length === 0) return;

    function setActiveStep(stepNumber: number) {
      // Update cards
      stepCards.forEach((card) => {
        const cardStep = parseInt(card.dataset.step || "1", 10);
        const isActive = cardStep === stepNumber;

        // Update card styles (light blue bg for active, white bg for inactive)
        if (isActive) {
          card.classList.remove(
            "border-gray-200",
            "bg-white",
            "hover:bg-primary/5",
          );
          card.classList.add(
            "border-primary",
            "bg-primary/5",
            "shadow-lg",
            "shadow-primary/10",
          );
        } else {
          card.classList.remove(
            "border-primary",
            "bg-primary/5",
            "shadow-lg",
            "shadow-primary/10",
          );
          card.classList.add(
            "border-gray-200",
            "bg-white",
            "hover:bg-primary/5",
          );
        }
        // Text colors remain unchanged (always dark)
      });

      // Update phone images
      phoneImages.forEach((img) => {
        const imgStep = parseInt(img.dataset.step || "1", 10);
        if (imgStep === stepNumber) {
          img.classList.remove("opacity-0", "absolute", "inset-0");
          img.classList.add("opacity-100", "relative");
        } else {
          img.classList.remove("opacity-100", "relative");
          img.classList.add("opacity-0", "absolute", "inset-0");
        }
      });
    }

    // Add click handlers
    stepCards.forEach((card) => {
      card.addEventListener("click", () => {
        const stepNumber = parseInt(card.dataset.step || "1", 10);
        setActiveStep(stepNumber);
      });
    });

    // Add scroll observer for mobile swiper
    const stepsContainer = document.getElementById("hiw-steps-container");
    if (stepsContainer && window.matchMedia("(max-width: 1024px)").matches) {
      const observerOptions = {
        root: stepsContainer,
        threshold: 0.6, // Trigger when 60% visible
        rootMargin: "0px -20% 0px -20%", // Focus on center area
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const card = entry.target as HTMLElement;
            const stepNumber = parseInt(card.dataset.step || "1", 10);
            setActiveStep(stepNumber);
          }
        });
      }, observerOptions);

      stepCards.forEach((card) => observer.observe(card));
    }
  }

  // Initialize on DOM ready
  document.addEventListener("DOMContentLoaded", initHowItWorks);
</script>
