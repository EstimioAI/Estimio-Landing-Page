---
const steps = [
  {
    number: 1,
    title: "Describe the Job",
    description:
      "Tell Estimio about the project using text or photos. Include dimensions, materials, and scope.",
    image: "/assets/screenshots/Hero Image Middle.png",
  },
  {
    number: 2,
    title: "AI Generates Estimate",
    description:
      "Our AI analyzes your input and creates a detailed, accurate estimate with localized pricing.",
    image: "/assets/screenshots/Breakdown.png",
  },
  {
    number: 3,
    title: "Adjust your Margins",
    description:
      "Fine-tune labor and material markups to ensure maximum profitability on every job.",
    image: "/assets/screenshots/Pricing.png",
  },
  {
    number: 4,
    title: "Send to Client",
    description:
      "Review, customize if needed, and send professional proposals directly to your clients.",
    image: "/assets/screenshots/Proposal.png",
  },
];
---

<section
  id="how-it-works"
  class="pt-0 pb-12 md:pb-20 lg:pb-24 bg-white scroll-mt-20"
  aria-labelledby="how-it-works-heading"
>
  <div class="section-container">
    <!-- Desktop Layout -->
    <div class="hidden lg:block max-w-6xl mx-auto px-4">
      <h2 id="how-it-works-heading" class="sr-only">How It Works</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-center">
        <!-- Left: Step Cards -->
        <div class="relative flex flex-col order-2 lg:order-1 min-w-0">
          <div
            id="hiw-steps-container-desktop"
            class="flex flex-col gap-4"
          >
            {
              steps.map((step, index) => (
                <button
                  type="button"
                  data-step={step.number}
                  data-image={step.image}
                  class:list={[
                    "hiw-step-card-desktop",
                    "text-left p-5 md:p-6 rounded-2xl border-2 transition-all duration-300 cursor-pointer relative z-10",
                    "w-full",
                    "hover:border-primary",
                    index === 0
                      ? "bg-primary/5 border-primary shadow-lg shadow-primary/10"
                      : "border-gray-200 bg-white hover:bg-primary/5",
                    "focus:outline-none",
                  ]}
                >
                  <div class="flex items-start gap-4">
                    <span
                      class:list={[
                        "text-3xl md:text-4xl font-bold shrink-0",
                        "bg-clip-text text-transparent bg-gradient-to-br from-primary to-primary/60",
                      ]}
                    >
                      0{step.number}
                    </span>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg md:text-xl font-semibold mb-1 text-text-primary">
                        {step.title}
                      </h3>
                      <p class="text-sm md:text-base leading-relaxed text-text-secondary">
                        {step.description}
                      </p>
                    </div>
                  </div>
                </button>
              ))
            }
          </div>
        </div>

        <!-- Right: Phone Image -->
        <div class="flex justify-center order-1 lg:order-2">
          <div class="relative w-[320px] xl:w-[360px]">
            <!-- Phone images container -->
            <div id="hiw-phone-container-desktop" class="relative">
              {
                steps.map((step, index) => (
                  <img
                    src={step.image}
                    alt={`Estimio app - ${step.title}`}
                    data-step={step.number}
                    class:list={[
                      "hiw-phone-image-desktop",
                      "w-full md:drop-shadow-2xl rounded-[2rem]",
                      index === 0
                        ? "relative opacity-100"
                        : "absolute inset-0 opacity-0",
                    ]}
                    style="transition: opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1);"
                    width="360"
                    height="740"
                    loading={index === 0 ? "eager" : "lazy"}
                    decoding="async"
                  />
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Carousel Layout - Native Scroll Snap with Peek -->
    <div class="lg:hidden">
      <!-- Phone Image Carousel with Native Scroll -->
      <div class="relative w-full mb-6">
        <!-- Carousel Container with padding for peek effect -->
        <div
          id="hiw-carousel"
          class="hiw-carousel flex overflow-x-auto snap-x snap-mandatory px-6"
        >
          {
            steps.map((step, index) => (
              <div
                class="hiw-slide flex-shrink-0 snap-center flex flex-col items-center"
                data-index={index}
                style="width: calc(100% - 48px);"
              >
                <!-- Phone Image -->
                <div class="w-[260px] sm:w-[280px] mb-6 mx-auto">
                  <img
                    src={step.image}
                    alt={`Estimio app - ${step.title}`}
                    class="w-full rounded-[2rem]"
                    width="360"
                    height="740"
                    loading={index === 0 ? "eager" : "lazy"}
                    decoding="async"
                  />
                </div>

                <!-- Description -->
                <div class="text-center max-w-sm px-4">
                  <span class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-br from-primary to-primary/60">
                    0{step.number}
                  </span>
                  <h3 class="text-xl font-semibold mb-2 text-text-primary mt-2">
                    {step.title}
                  </h3>
                  <p class="text-base leading-relaxed text-text-secondary">
                    {step.description}
                  </p>
                </div>
              </div>
            ))
          }
          <!-- Spacer for last slide peek balance -->
          <div class="flex-shrink-0 w-6" aria-hidden="true"></div>
        </div>
      </div>

      <!-- Progress Indicators - Larger tap targets -->
      <div class="flex justify-center gap-3 mt-4">
        {
          steps.map((step, index) => (
            <button
              type="button"
              data-dot-index={index}
              class:list={[
                "hiw-dot",
                "relative h-11 flex items-center justify-center transition-all duration-200",
                index === 0 ? "w-11" : "w-11",
              ]}
              aria-label={`Go to step ${step.number}`}
            >
              <span
                class:list={[
                  "hiw-dot-inner block rounded-full transition-all duration-200",
                  index === 0
                    ? "w-8 h-2 bg-primary"
                    : "w-2 h-2 bg-gray-300",
                ]}
              />
            </button>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  // Desktop functionality
  function initHowItWorksDesktop() {
    const stepCards = document.querySelectorAll<HTMLButtonElement>(".hiw-step-card-desktop");
    const phoneImages = document.querySelectorAll<HTMLImageElement>(".hiw-phone-image-desktop");

    if (stepCards.length === 0) return;

    function setActiveStep(stepNumber: number) {
      stepCards.forEach((card) => {
        const cardStep = parseInt(card.dataset.step || "1", 10);
        const isActive = cardStep === stepNumber;

        if (isActive) {
          card.classList.remove("border-gray-200", "bg-white", "hover:bg-primary/5");
          card.classList.add("border-primary", "bg-primary/5", "shadow-lg", "shadow-primary/10");
        } else {
          card.classList.remove("border-primary", "bg-primary/5", "shadow-lg", "shadow-primary/10");
          card.classList.add("border-gray-200", "bg-white", "hover:bg-primary/5");
        }
      });

      phoneImages.forEach((img) => {
        const imgStep = parseInt(img.dataset.step || "1", 10);
        if (imgStep === stepNumber) {
          img.classList.remove("opacity-0", "absolute", "inset-0");
          img.classList.add("opacity-100", "relative");
        } else {
          img.classList.remove("opacity-100", "relative");
          img.classList.add("opacity-0", "absolute", "inset-0");
        }
      });
    }

    stepCards.forEach((card) => {
      card.addEventListener("click", () => {
        const stepNumber = parseInt(card.dataset.step || "1", 10);
        setActiveStep(stepNumber);
      });
    });
  }

  // Mobile carousel functionality - Native scroll with Intersection Observer
  function initHowItWorksMobile() {
    const carousel = document.getElementById("hiw-carousel");
    const slides = document.querySelectorAll<HTMLElement>(".hiw-slide");
    const dots = document.querySelectorAll<HTMLButtonElement>(".hiw-dot");
    const dotInners = document.querySelectorAll<HTMLElement>(".hiw-dot-inner");

    if (!carousel || slides.length === 0) return;

    let currentIndex = 0;

    // Update dot indicators
    function updateDots(index: number) {
      dotInners.forEach((inner, i) => {
        if (i === index) {
          inner.classList.remove("w-2", "h-2", "bg-gray-300");
          inner.classList.add("w-8", "h-2", "bg-primary");
        } else {
          inner.classList.remove("w-8", "bg-primary");
          inner.classList.add("w-2", "h-2", "bg-gray-300");
        }
      });
    }

    // Scroll to specific slide
    function scrollToSlide(index: number) {
      const targetSlide = slides[index];
      if (targetSlide) {
        targetSlide.scrollIntoView({
          behavior: "smooth",
          block: "nearest",
          inline: "center"
        });
      }
    }

    // Intersection Observer to detect current slide
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
            const index = parseInt((entry.target as HTMLElement).dataset.index || "0", 10);
            if (index !== currentIndex) {
              currentIndex = index;
              updateDots(currentIndex);
            }
          }
        });
      },
      {
        root: carousel,
        threshold: 0.5,
        rootMargin: "0px"
      }
    );

    // Observe all slides
    slides.forEach((slide) => observer.observe(slide));

    // Dot click handlers
    dots.forEach((dot, index) => {
      dot.addEventListener("click", () => {
        scrollToSlide(index);
      });
    });

    // Initialize
    updateDots(0);
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initHowItWorksDesktop();
      initHowItWorksMobile();
    });
  } else {
    initHowItWorksDesktop();
    initHowItWorksMobile();
  }
</script>

<style>
  /* Native scroll carousel */
  .hiw-carousel {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
  }

  .hiw-carousel::-webkit-scrollbar {
    display: none; /* Chrome/Safari/Opera */
  }

  /* Smooth snap points */
  .hiw-slide {
    scroll-snap-align: center;
    scroll-snap-stop: always;
  }

  /* Gap between slides for peek effect */
  .hiw-slide + .hiw-slide {
    margin-left: 16px;
  }

  /* Dot hover state */
  .hiw-dot:hover .hiw-dot-inner {
    background-color: var(--color-primary);
    opacity: 0.7;
  }

  .hiw-dot:active .hiw-dot-inner {
    transform: scale(0.9);
  }
</style>
